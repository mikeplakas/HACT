@page
@model HACT.Pages.NewsModel
@inject IHttpContextAccessor HttpContextAccessor

@{
    ViewData["CshtmlName"] = "News";
    ViewData["Title"] = "News";

    var user = HttpContextAccessor.HttpContext?.User;
    bool isAdmin = user?.Identity?.IsAuthenticated == true && user.IsInRole("Admin");
    var category = HttpContextAccessor.HttpContext?.Request.Query["category"].ToString();
}

<div class="container-fluid py-5 wow fadeInUp" data-wow-delay="0.1s" style="background:#fff;">
    <div class="container py-5">

        <!-- Header -->
        <div class="d-flex align-items-center justify-content-between mb-4 flex-wrap gap-3">
            <div class="section-title position-relative pb-3 mb-0">
                <h5 class="fw-bold text-primary text-uppercase">
                    @(string.IsNullOrEmpty(category) ? "Latest News" : $"Latest {category}")
                </h5>
                <h1 class="mb-0" style="color:#0b2343;">
                    @(string.IsNullOrEmpty(category) ? "Read The Latest News" : $"Read The Latest {category}")
                </h1>
            </div>

            <div class="d-flex align-items-center">
                <label class="me-2 mb-0 fw-semibold" style="color:#0b2343;">Category</label>
                <select id="categorySelect" class="form-select border-0 shadow-sm" style="background:#f0f2f5; color:#0b2343;">
                    <option value="">All</option>
                    <option value="Articles" selected="@(category == "Articles")">Articles</option>
                    <option value="Events" selected="@(category == "Events")">Events</option>
                </select>
            </div>
        </div>

        <!-- News List -->
        <div id="newsList" class="row g-5">
            @if (Model.News?.Count > 0)
            {
                foreach (var item in Model.News)
                {
                    <div class="col-lg-4 d-flex align-items-stretch news-card">
                        <div class="rounded-4 overflow-hidden d-flex flex-column w-100 shadow-sm" style="background:#f0f2f5;">
                            <div class="position-relative overflow-hidden" style="height: 200px;">
                                <img class="img-fluid w-100 h-100" style="object-fit:cover;" src="@item.ImageUrl" alt="@item.Title">
                            </div>
                            <div class="p-4 d-flex flex-column justify-content-between flex-grow-1">
                                <div>
                                    <div class="d-flex mb-3 justify-content-between">
                                        <small><i class="far fa-calendar-alt text-primary me-2"></i>@item.DatePosted.ToString("dd MMM, yyyy")</small>
                                        <span class="badge bg-secondary">@item.Category</span>
                                    </div>
                                    <h5 class="mb-2 text-truncate" style="color:#0b2343;">@item.Title</h5>
                                    <p style="min-height:80px; color:#334155;">
                                        @(item.Content?.Length > 100 ? item.Content.Substring(0, 100) + "..." : item.Content)
                                    </p>
                                </div>
                                <div class="mt-auto pt-2">
                                    <a class="btn btn-sm btn-outline-primary me-2"
                                       asp-page="/NewsDetail"
                                       asp-route-id="@item.Id"
                                       asp-route-category="@item.Category">
                                        🔍 Read More
                                    </a>

                                    @if (isAdmin)
                                    {
                                        <a class="btn btn-sm btn-outline-secondary me-2" asp-page="/Admin/EditNew" asp-route-id="@item.Id">✏️ Edit</a>
                                        <a class="btn btn-sm btn-outline-danger" asp-page="/Admin/DeleteNew" asp-route-id="@item.Id">🗑 Delete</a>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="text-center text-muted py-5">No news found.</div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const select = document.getElementById("categorySelect");
            const container = document.getElementById("newsList");

            async function loadNews(cat) {
                container.innerHTML = "<div class='text-center text-muted py-5'>⏳ Loading...</div>";

                try {
                    const res = await fetch(`?handler=Filter&category=${encodeURIComponent(cat)}`);
                    const data = await res.json();

                    if (!Array.isArray(data) || data.length === 0) {
                        container.innerHTML = "<div class='text-center text-muted py-5'>No news found.</div>";
                        return;
                    }

                    container.innerHTML = "";
                    for (const item of data) {
                        const dateStr = new Date(item.datePosted).toLocaleDateString();
                        const shortText = item.content && item.content.length > 100
                            ? item.content.substring(0,100) + "..."
                            : (item.content || "");

                        container.insertAdjacentHTML("beforeend", `
                            <div class="col-lg-4 d-flex align-items-stretch news-card">
                                <div class="rounded-4 overflow-hidden d-flex flex-column w-100 shadow-sm" style="background:#f0f2f5;">
                                    <div class="position-relative overflow-hidden" style="height: 200px;">
                                        <img class="img-fluid w-100 h-100" style="object-fit:cover;" src="${item.imageUrl}" alt="${item.title}">
                                    </div>
                                    <div class="p-4 d-flex flex-column justify-content-between flex-grow-1">
                                        <div>
                                            <div class="d-flex mb-3 justify-content-between">
                                                <small><i class="far fa-calendar-alt text-primary me-2"></i>${dateStr}</small>
                                                <span class="badge bg-secondary">${item.category}</span>
                                            </div>
                                            <h5 class="mb-2 text-truncate" style="color:#0b2343;">${item.title}</h5>
                                            <p style="min-height:80px; color:#334155;">${shortText}</p>
                                        </div>
                                        <div class="mt-auto pt-2">
                                            <a class="btn btn-sm btn-outline-primary me-2"
                                                       href="/NewsDetail/${item.id}?category=${encodeURIComponent(item.category)}">
                                               🔍 Read More
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    }
                } catch (err) {
                    console.error(err);
                    container.innerHTML = "<div class='text-center text-danger py-5'>❌ Failed to load news.</div>";
                }
            }

            select.addEventListener("change", () => loadNews(select.value));
        });
    </script>
}
